#!/usr/bin/env node
'use strict';

let path = require('path');
let fs = require('fs');
let appRoot = process.cwd();
let koa800ConfigPath = path.join(appRoot, 'koa800.js');

// 检测是否有项目koa800配置
if (!fs.existsSync(koa800ConfigPath)) {
  console.error(`[KOA800|eslint|pre-commit] 缺乏koa800配置文件:${koa800ConfigPath}`);
  process.exit(1);
}

// eslint 配置
const koa800Config = require(koa800ConfigPath);
let eslintConfig = koa800Config.eslint;
if (!eslintConfig) {
  process.exit(0);
}

if (eslintConfig !== 'error' && eslintConfig !== 'warning') {
  eslintConfig = 'error';
}

// 检测eslint是否存在
const eslintPath = path.join(appRoot, 'node_modules/.bin/eslint');
if (!fs.existsSync(eslintPath)) {
  console.log(`[KOA800|eslint|pre-commit] 项目未安装eslint`);
  process.exit(1);
}

const exec = require('child_process').exec;
const gitcmd = 'git diff --cached --name-only --diff-filter=ACM | grep -v "^test\|^node_modules\|^public/assets\|^app/assets" | grep ".js$"';

require('child_process').exec(gitcmd, (error, stdout, stderr) => {
  // 如果没有结果, grep的错误码会是1, 因此用error判断不准确, 用stderr判断
  if (stderr) { // 比如没有安装git
    console.error(`[KOA800|eslint|pre-commit] git error: ${stderr}`);
    process.exit(0);
  }

  stdout = stdout.trim();
  if (!stdout) process.exit(0); // 没有需要lint的js文件

  let changedFiles = stdout.split(/\s+/);

  console.log('执行 eslint ...');
  require('child_process').execFile(eslintPath, changedFiles, (error, stdout, stderr) => {
    console.log(stdout); // lint 的错误会在stdout中
    if (error) { // lint 有错时, 会有error
      console.error(`[KOA800|eslint|pre-commit] eslint error: ${error}`);
      console.error(stderr); // lint 的错误不会在stderr中
      process.exit(eslintConfig === 'warning' ? 0 : 1);
    }
    console.log('[KOA800|eslint|pre-commit] eslint 成功');
  });
});
